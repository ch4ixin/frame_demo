<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人脸录入</title>
    <link rel="shortcut icon" href="../../../resource/img/favicon.ico"/>
    <link href="../../../resource/Hplus-v.4.1.0/css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="../../../resource/Hplus-v.4.1.0/css/font-awesome.css?v=4.4.0" rel="stylesheet">
    <link href="../../../resource/Hplus-v.4.1.0/css/plugins/iCheck/custom.css" rel="stylesheet">
    <link href="../../../resource/Hplus-v.4.1.0/css/plugins/datapicker/datepicker3.css" rel="stylesheet">
    <link href="../../../resource/Hplus-v.4.1.0/css/animate.css" rel="stylesheet">
    <link href="../../../resource/Hplus-v.4.1.0/css/style.css?v=4.1.0" rel="stylesheet">
    <link rel="stylesheet" href="../../../resource/sweetalert-master/dist/sweetalert.css">
	<style type="text/css">
		.x-panel-default-framed {
		    border-color: #CFCFCF;
		}
	</style>
</head>

<body class="gray-bg">
	<div class="spiner-cx" id="bbs" style="display:none">
	    <div class="spiner-example">
	         <div class="sk-spinner sk-spinner-three-bounce">
	             <div class="sk-bounce1"></div>
	             <div class="sk-bounce2"></div>
	             <div class="sk-bounce3"></div>
	         </div>
	    </div>
	</div>
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>人员编辑<small></small></h5>
                    </div>
                    <div class="ibox-content">
                        <form class="form-horizontal" method="get">
                        	<div class="form-group">
                                <label class="col-sm-2 control-label">ID</label>
                                <div class="col-sm-10">
                                    <input type="text" id="code" readonly="readonly" class="form-control">
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">姓名</label>
                                <div class="col-sm-10">
                                    <div class="input-group">
                                     	<input type="text" id="personName" class="form-control">
                                        <div class="input-group-btn">
	                                        <button tabindex="-1" onclick="new Device().startFun()" class="btn btn-primary" type="button">读取身份证信息</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">编号（学号/工号）</label>
                                <div class="col-sm-10">
                                    <input type="text"  id="note" class="form-control">
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="hr-line-dashed"></div>
                             <div class="form-group">
                                <label class="col-sm-2 control-label">性别</label>
                                <div class="col-sm-10">
                                    <input type="text"  id="gender" class="form-control">
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">民族</label>
                                <div class="col-sm-10">
                                    <input type="text"  id="nation" class="form-control">
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">住址</label>
                                <div class="col-sm-10">
                                    <input type="text"  id="address" class="form-control">
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">身份证号码</label>
                                <div class="col-sm-10">
                                    <input type="text"  id="certNumber" class="form-control">
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group" id="data_1">
                                <label class="col-sm-2 control-label">有效期至</label>
                                <div class="col-sm-10">
                                 	<div class="input-group date">
		                                <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
		                                <input type="text" class="form-control"  id="deadline"  value="">
		                            </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">人脸录入</label>
                                <div class="col-sm-10">
                                    <video id="video" style="position: relative;border-radius: 10px;">
                                    </video>
                                    <input type="text"  id="face_id" hidden="hidden">
                                    <div style="position: absolute;left: 17.5%;bottom: 2%;border-radius: 50%;box-shadow: 0.5px 0.5px 10px #230;">
    	                                <img src="../../../resource/img/take.png" id="capture">
                                    </div>
                                    <canvas id="canvas" width="540" height="400" style="position: relative;border-radius: 10px"></canvas>
                                    <img width="120px" height="140px" src="../../../resource/js/zkt/images/userImage.png" onerror="this.src='images/userImage.png'" style="margin-left:5px" id="id_img_pers">
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-sm-4 col-sm-offset-2">
                                    <a class="btn btn-primary" href="javascript:submit()" type="submit">修改</a>
                                    <a class="btn btn-white" href="javascript:history.go(-1)" type="button">返回</a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 全局js -->
    <script src="../../../resource/Hplus-v.4.1.0/js/jquery.min.js?v=2.1.4"></script>
    <script src="../../../resource/Hplus-v.4.1.0/js/bootstrap.min.js?v=3.3.6"></script>
   	<script src="../../../resource/Hplus-v.4.1.0/js/plugins/datapicker/bootstrap-datepicker.js"></script>
	<script src="../../../resource/Hplus-v.4.1.0/js/demo/form-advanced-demo.js"></script>
	<script src="../../../resource/Hplus-v.4.1.0/js/plugins/cropper/cropper.min.js"></script>
    <!-- 自定义js -->
    <script src="../../../resource/Hplus-v.4.1.0/js/content.js"></script>
	<script src="../../../resource/sweetalert-master/dist/sweetalert.min.js"></script>
	<script type="text/javascript" src="../../../resource/js/zkt/jBox/jquery.jBox-2.3.min.js"></script>
	<!-- zkt js -->
	<script type="text/javascript" src="../../../resource/js/zkt/js/baseISSObject.js"></script>
	<script type="text/javascript" src="../../../resource/js/zkt/js/baseISSOnline.js"></script>
	<script type="text/javascript" src="../../../resource/js/zkt/js/common.js"></script>
    <!-- iCheck -->
    <script src="../../../resource/Hplus-v.4.1.0/js/plugins/iCheck/icheck.min.js"></script>
    <script type="text/javascript" src="http://tajs.qq.com/stats?sId=9051096" charset="UTF-8"></script>
    <script type="text/javascript">

    	document.onreadystatechange = loadingChange;//当页面加载状态改变的时候执行这个方法.    
	    function loadingChange() {
	        if(document.readyState == "complete"){//当页面加载状态为完全结束时进入     
	            window.setTimeout(function(){
	                var ui =document.getElementById("bbs");
		        	ui.style.display="none";
	            },500);
	        }     
	    }
    	
	    /*获取到Url里面的参数*/
	    (function ($) {
	      $.getUrlParam = function (name) {
	       var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
	       var r = window.location.search.substr(1).match(reg);
	       if (r != null) return unescape(r[2]); return null;
	      }
	    })(jQuery);
	    
	  //访问用户媒体设备的兼容方法
	    function getUserMedia(constraints, success, error) {
	      if (navigator.mediaDevices.getUserMedia) {
	        //最新的标准API
	        navigator.mediaDevices.getUserMedia(constraints).then(success).catch(error);
	      } else if (navigator.webkitGetUserMedia) {
	        //webkit核心浏览器
	        navigator.webkitGetUserMedia(constraints,success, error)
	      } else if (navigator.mozGetUserMedia) {
	        //firfox浏览器
	        navigator.mozGetUserMedia(constraints, success, error);
	      } else if (navigator.getUserMedia) {
	        //旧版API
	        navigator.getUserMedia(constraints, success, error);
	      }
	    }
	   
	    let video = document.getElementById('video');
	    let canvas = document.getElementById('canvas');
	    let context = canvas.getContext('2d');
	   
	    function success(stream) {
	      //兼容webkit核心浏览器
	      let CompatibleURL = window.URL || window.webkitURL;
	      //将视频流设置为video元素的源
	      console.log(stream);
	      //video.src = CompatibleURL.createObjectURL(stream);
	      video.srcObject = stream;
	      video.play();
	    }
	   
	    function error(error) {
	      console.log(`访问用户媒体设备失败${error.name}, ${error.message}`);
		  swal ( `${error.name}` , `访问用户媒体设备失败` ,  "error" );
	    }
	   
	    if (navigator.mediaDevices.getUserMedia || navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia) {
	      //调用用户媒体设备, 访问摄像头
	      getUserMedia({video : {width: 1000, height: 700}}, success, error);
	    } else {
	      console.log('不支持访问用户媒体');
	    }
	    
	    document.getElementById('capture').addEventListener('click', function () {
	      context.drawImage(video, 0, 0, 540, 400);
	      $("#face_id").val(canvas.toDataURL());
	      console.log(canvas.toDataURL());
	    })
	    
	     
	    $.ajax({
	        url: "/shannonpay/shop/ai/user/edit_form.htm?kid="+$.getUrlParam('kid'),
	        dataType: "json",
	        success: function(data){
		       	 console.log(data);
		       	$("#code").val(data.code);
		       	$("#note").val(data.note);
		       	$("#certNumber").val(data.identity_id);
		       	$("#personName").val(data.name);
		       	$("#address").val(data.address);
		       	$("#gender").val(data.sex);
		       	$("#nation").val(data.nation);
		       	$("#deadline").val(dateFormat_2(data.deadline));
				$("#id_img_pers").attr("src",data.picture);
				
				var img = new Image();
				img.src = data.face_img;
				img.onload = function(){
					context.drawImage(img, 0, 0, 540, 400);
				}
	        }
	    });
	    
    	function submit() {
	    	var ui =document.getElementById("bbs");
        	ui.style.display="block";

			var face_id = $("#face_id").val().substring($("#face_id").val().indexOf('base64,')+7);
			var identity_id = $("#certNumber").val();
			var note = $("#note").val();
			var name = $("#personName").val();
			var sex = $("#gender").val();
			var nation = $("#nation").val();
			var address = $("#address").val();
			var picture = $('#id_img_pers').attr('src').substring($('#id_img_pers').attr('src').indexOf('base64,')+7);
			var deadline = $("#deadline").val()+' 00:00:00';
			
			if(name==""||identity_id==""||$("#deadline").val()==""){
				 swal ( "保存错误" ,  "当前信息为空" ,  "error" );
				 var ui =document.getElementById("bbs");
                 ui.style.display="none";
	    		 return;
			}
			
			$.ajax({
                 url: "/shannonpay/shop/ai/user/edit.htm",
                 data: {identity_id:identity_id,name:name,face_id:face_id,sex:sex,nation:nation,address:address,picture:picture,kid:$.getUrlParam('kid'),deadline_note:deadline,note:note},  
	             dataType: "json",
	             success: function(data){
	            	 if(data.success == true){
		 	           		swal({
		 	           			 title: data.tip.msg,
			                     text: "",
			                     type: data.tip.type
			                 }, function () {
			                	 var ui =document.getElementById("bbs");
			                 	 ui.style.display="none";
				            	 history.go(0)
			                 });
		 	           	 }  
		 	           	 if(data.success == false){
		 	           		swal({
			                     title: data.tip.msg,
			                     text: "图像中未找到人脸，请对视摄像头，重新调整 O(∩_∩)O！",
			                     type: data.tip.type
			                 }, function () {
			                	 var ui =document.getElementById("bbs");
			                 	 ui.style.display="none";
			                 });
		 	           	 } 
                 }, 
                 error: function(XMLHttpRequest, textStatus, errorThrown){
                     //查看错误信息
                     alert(XMLHttpRequest.status);
                     alert(XMLHttpRequest.readyState);
                     alert(textStatus);
                 }
	         });
		};	
		
		//返回 01-12 的月份值  
		function getMonth(date){ 
		  var month = ""; 
		  month = date.getMonth() + 1; //getMonth()得到的月份是0-11 
		  if(month<10){ 
		    month = "0" + month; 
		  } 
		  return month; 
		}
		
		//返回01-30的日期 
		function getDay(date){
		  var day = ""; 
		  day = date.getDate(); 
		  if(day<10){ 
		    day = "0" + day; 
		  } 
		  return day; 
		}

		function dateFormat_2(longTypeDate){ 
		  var dateType = ""; 
		  var date = new Date(); 
		  date.setTime(longTypeDate); 
		  dateType = date.getFullYear()+"-"+getMonth(date)+"-"+getDay(date);//yyyy-MM-dd格式日期
		  return dateType;
		}
    </script>
</body>
</html>